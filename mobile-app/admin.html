<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Admin - Dispensador</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .pin-container {
            max-width: 500px;
            margin: 50px auto;
        }

        .pin-boxes {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 40px 0;
        }

        .pin-box {
            width: 60px;
            height: 80px;
            font-size: 48px;
            text-align: center;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            transition: all 0.3s;
            outline: none;
            font-weight: bold;
            color: #667eea;
        }

        .pin-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .pin-box.filled {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }

        .admin-form {
            max-width: 600px;
            margin: 30px auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin: 30px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .quick-select {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .quick-btn {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            border-color: #667eea;
            background: #667eea15;
        }

        .quick-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .success-animation {
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #667eea;
            color: white;
        }

        .patients-table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .patients-table {
            width: 100%;
            border-collapse: collapse;
        }

        .patients-table thead {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .patients-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        .patients-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .patients-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .patients-table tbody tr:hover {
            background: #667eea15;
        }

        .patients-table tbody tr.selected {
            background: #667eea25;
        }

        .copy-btn {
            padding: 5px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #764ba2;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: #4CAF50;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .refresh-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Panel de Administraci√≥n</h1>
        <p>Gesti√≥n de Prescripciones</p>
    </div>

    <div class="container">
        <!-- PIN Screen -->
        <div id="screen-pin" class="card pin-container">
            <h2 style="text-align: center; margin-bottom: 10px;">Ingresa el PIN</h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                PIN de administrador de 6 d√≠gitos
            </p>

            <div class="pin-boxes">
                <input type="text" class="pin-box" maxlength="1" data-index="0" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="pin-box" maxlength="1" data-index="1" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="pin-box" maxlength="1" data-index="2" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="pin-box" maxlength="1" data-index="3" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="pin-box" maxlength="1" data-index="4" inputmode="numeric" pattern="[0-9]">
                <input type="text" class="pin-box" maxlength="1" data-index="5" inputmode="numeric" pattern="[0-9]">
            </div>

            <div class="info-box">
                <strong>üí° Consejo de seguridad:</strong><br>
                <!-- El PIN predeterminado es <code>000000</code><br> -->
                C√°mbialo en las variables de entorno (<code>ADMIN_PIN</code>)
            </div>
        </div>

        <!-- Admin Form -->
        <div id="screen-admin" class="card admin-form hidden">
            <button class="logout-btn" onclick="admin.logout()">Cerrar Sesi√≥n</button>

            <h2 style="margin-bottom: 30px;">üíä Crear Prescripci√≥n</h2>

            <form id="prescription-form" onsubmit="admin.submitPrescription(event)">
                <!-- Paciente -->
                <div class="section-title">
                    üë§ Datos del Paciente
                    <button type="button" class="refresh-btn" onclick="admin.loadPatients()" style="float: right; margin-top: -5px;">
                        üîÑ Actualizar Lista
                    </button>
                </div>

                <div class="info-box" style="margin-bottom: 15px;">
                    <strong>üí° Consejo:</strong> Haz click en una fila para seleccionar el paciente autom√°ticamente
                </div>

                <div class="patients-table-container" id="patients-container">
                    <div class="loading active">
                        <div class="spinner" style="width: 30px; height: 30px; border-width: 3px; margin: 20px auto;"></div>
                        <p style="text-align: center; color: #666;">Cargando pacientes...</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="patient-cedula">C√©dula del Paciente Seleccionado *</label>
                    <input 
                        type="text" 
                        id="patient-cedula" 
                        required 
                        pattern="[0-9]{6,10}"
                        placeholder="Click en la tabla o escribe manualmente"
                    >
                    <small style="color: #999; font-size: 12px;">
                        üí° Haz click en una fila de la tabla para seleccionar autom√°ticamente
                    </small>
                </div>

                <!-- Medicamento -->
                <div class="section-title">üíä Medicamento</div>
                
                <div class="quick-select">
                    <button type="button" class="quick-btn" onclick="admin.selectMedicine('Paracetamol 500mg', 1, 'tabletas')">
                        Paracetamol 500mg
                    </button>
                    <button type="button" class="quick-btn" onclick="admin.selectMedicine('Ibuprofeno 400mg', 1, 'tabletas')">
                        Ibuprofeno 400mg
                    </button>
                    <button type="button" class="quick-btn" onclick="admin.selectMedicine('Amoxicilina 500mg', 1, 'c√°psulas')">
                        Amoxicilina 500mg
                    </button>
                </div>

                <div class="form-group full-width">
                    <label for="medicine-name">Nombre del Medicamento *</label>
                    <input 
                        type="text" 
                        id="medicine-name" 
                        required 
                        placeholder="Ej: Paracetamol 500mg"
                    >
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="dosage-amount">Cantidad *</label>
                        <input 
                            type="number" 
                            id="dosage-amount" 
                            required 
                            min="0.1"
                            step="0.5"
                            value="1,1"
                            placeholder="1.1"
                        >
                    </div>

                    <div class="form-group">
                        <label for="dosage-unit">Unidad *</label>
                        <select id="dosage-unit" required>
                            <option value="tabletas">Tabletas</option>
                            <option value="c√°psulas">C√°psulas</option>
                            <option value="ml">ml</option>
                            <option value="mg">mg</option>
                            <option value="g">g</option>
                            <option value="gotas">Gotas</option>
                        </select>
                    </div>
                </div>

                <!-- Frecuencia -->
                <div class="section-title">‚è∞ Frecuencia y Duraci√≥n</div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="frequency-times">Veces al d√≠a *</label>
                        <input 
                            type="number" 
                            id="frequency-times" 
                            required 
                            min="1"
                            max="24"
                            value="3"
                            placeholder="3"
                        >
                    </div>

                    <div class="form-group">
                        <label for="frequency-period">Periodo</label>
                        <select id="frequency-period" required>
                            <option value="diario">Diario</option>
                            <option value="cada 8 horas">Cada 8 horas</option>
                            <option value="cada 12 horas">Cada 12 horas</option>
                            <option value="cada 24 horas">Cada 24 horas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="max-daily">Dosis m√°ximas/d√≠a *</label>
                        <input 
                            type="number" 
                            id="max-daily" 
                            required 
                            min="1"
                            max="10"
                            value="3"
                            placeholder="3"
                        >
                    </div>

                    <div class="form-group">
                        <label for="duration">Duraci√≥n (d√≠as) *</label>
                        <input 
                            type="number" 
                            id="duration" 
                            required 
                            min="1"
                            max="365"
                            value="30"
                            placeholder="30"
                        >
                    </div>
                </div>

                <!-- M√©dico -->
                <div class="section-title">üë®‚Äç‚öïÔ∏è Datos del M√©dico</div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="doctor-name">Nombre del M√©dico *</label>
                        <input 
                            type="text" 
                            id="doctor-name" 
                            required 
                            placeholder="Dr. Garc√≠a"
                        >
                    </div>

                    <div class="form-group">
                        <label for="doctor-license">Licencia M√©dica *</label>
                        <input 
                            type="text" 
                            id="doctor-license" 
                            required 
                            placeholder="MED-12345"
                        >
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="doctor-specialty">Especialidad</label>
                    <input 
                        type="text" 
                        id="doctor-specialty" 
                        placeholder="Medicina General"
                    >
                </div>

                <div class="form-group full-width">
                    <label for="notes">Notas (opcional)</label>
                    <textarea 
                        id="notes" 
                        rows="3"
                        placeholder="Tomar despu√©s de las comidas con agua..."
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; resize: vertical;"
                    ></textarea>
                </div>

                <div class="controls">
                    <button type="button" class="btn btn-secondary" onclick="admin.logout()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ‚úì Crear Prescripci√≥n
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading -->
        <div id="screen-loading" class="card hidden">
            <div class="loading active">
                <div class="spinner"></div>
                <h3 style="color: #333; margin-bottom: 10px;">Procesando...</h3>
                <p style="color: #666;">Creando prescripci√≥n</p>
            </div>
        </div>

        <!-- Success -->
        <div id="screen-success" class="card hidden">
            <div class="success-box success-animation">
                <h3>‚úÖ Prescripci√≥n Creada</h3>
                <div id="prescription-details" style="margin: 20px 0;"></div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="admin.logout()">
                        Cerrar Sesi√≥n
                    </button>
                    <button class="btn btn-primary" onclick="admin.createAnother()">
                        Crear Otra
                    </button>
                </div>
            </div>
        </div>

        <!-- Error -->
        <div id="screen-error" class="card hidden">
            <div class="error-box">
                <h3>‚ùå Error</h3>
                <p id="error-message" style="margin: 15px 0; font-size: 16px;"></p>
                <button class="btn btn-primary" onclick="admin.backToForm()">
                    Volver al Formulario
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api'
        const ADMIN_PIN = '098765' // Change in production!

        class AdminPanel {
            constructor() {
                this.authenticated = false
                this.init()
            }

            init() {
                this.setupPinBoxes()
                this.showScreen('pin')
            }

            setupPinBoxes() {
                const boxes = document.querySelectorAll('.pin-box')
                
                boxes.forEach((box, index) => {
                    box.addEventListener('input', (e) => {
                        const value = e.target.value
                        
                        // Only allow digits
                        if (!/^\d$/.test(value)) {
                            e.target.value = ''
                            return
                        }

                        e.target.classList.add('filled')

                        // Auto-focus next box
                        if (value && index < boxes.length - 1) {
                            boxes[index + 1].focus()
                        }

                        // Check PIN when all filled
                        if (index === boxes.length - 1 && value) {
                            this.checkPin()
                        }
                    })

                    box.addEventListener('keydown', (e) => {
                        // Backspace: go to previous box
                        if (e.key === 'Backspace' && !box.value && index > 0) {
                            boxes[index - 1].focus()
                            boxes[index - 1].value = ''
                            boxes[index - 1].classList.remove('filled')
                        }

                        // Enter: check PIN
                        if (e.key === 'Enter') {
                            this.checkPin()
                        }
                    })

                    box.addEventListener('paste', (e) => {
                        e.preventDefault()
                        const paste = e.clipboardData.getData('text')
                        const digits = paste.replace(/\D/g, '').slice(0, 6)
                        
                        digits.split('').forEach((digit, i) => {
                            if (boxes[i]) {
                                boxes[i].value = digit
                                boxes[i].classList.add('filled')
                            }
                        })

                        if (digits.length === 6) {
                            this.checkPin()
                        }
                    })
                })

                // Auto-focus first box
                boxes[0].focus()
            }

            checkPin() {
                const boxes = document.querySelectorAll('.pin-box')
                const pin = Array.from(boxes).map(b => b.value).join('')

                if (pin.length !== 6) {
                    this.shake()
                    return
                }

                if (pin === ADMIN_PIN) {
                    this.authenticated = true
                    this.showScreen('admin')
                    this.loadPatients()
                } else {
                    this.shake()
                    boxes.forEach(b => {
                        b.value = ''
                        b.classList.remove('filled')
                    })
                    boxes[0].focus()
                }
            }

            async loadPatients() {
                const container = document.getElementById('patients-container')
                
                container.innerHTML = `
                    <div class="loading active">
                        <div class="spinner" style="width: 30px; height: 30px; border-width: 3px; margin: 20px auto;"></div>
                        <p style="text-align: center; color: #666;">Cargando pacientes...</p>
                    </div>
                `

                try {
                    const response = await fetch(`${API_BASE_URL}/patients`)
                    const data = await response.json()

                    if (response.ok && data.success) {
                        this.renderPatientsTable(data.patients)
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <p>‚ùå Error al cargar pacientes</p>
                                <button class="btn btn-primary" onclick="admin.loadPatients()" style="margin-top: 10px;">
                                    Reintentar
                                </button>
                            </div>
                        `
                    }
                } catch (error) {
                    console.error('Error loading patients:', error)
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>‚ùå Error de conexi√≥n</p>
                            <button class="btn btn-primary" onclick="admin.loadPatients()" style="margin-top: 10px;">
                                Reintentar
                            </button>
                        </div>
                    `
                }
            }

            renderPatientsTable(patients) {
                const container = document.getElementById('patients-container')

                if (!patients || patients.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>üë§ No hay pacientes registrados</p>
                            <p style="font-size: 14px; color: #999; margin-top: 10px;">
                                Los usuarios deben registrarse desde la app m√≥vil
                            </p>
                        </div>
                    `
                    return
                }

                const tableHTML = `
                    <table class="patients-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>C√©dula</th>
                                <th>Tel√©fono</th>
                                <th>Registrado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${patients.map(patient => `
                                <tr onclick="admin.selectPatient('${patient.cedula}', '${patient.name}')" data-cedula="${patient.cedula}" title="Click para seleccionar">
                                    <td>${patient.name}</td>
                                    <td><strong>${patient.cedula}</strong></td>
                                    <td>${patient.phone || '-'}</td>
                                    <td style="font-size: 12px; color: #999;">
                                        ${new Date(patient.registeredAt).toLocaleDateString()}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `

                container.innerHTML = tableHTML
            }

            selectPatient(cedula, name) {
                document.getElementById('patient-cedula').value = cedula
                
                // Highlight selected row
                document.querySelectorAll('.patients-table tbody tr').forEach(row => {
                    row.classList.remove('selected')
                })
                event.currentTarget.classList.add('selected')

                // Show toast
                this.showToast(`‚úì Seleccionado: ${name}`)
                
                // Focus on next field
                document.getElementById('medicine-name').focus()
            }

            async copyToClipboard(text, button) {
                try {
                    await navigator.clipboard.writeText(text)
                    
                    const originalText = button.textContent
                    button.textContent = '‚úì Copiado'
                    button.classList.add('copied')
                    
                    setTimeout(() => {
                        button.textContent = originalText
                        button.classList.remove('copied')
                    }, 2000)
                } catch (error) {
                    console.error('Error copying:', error)
                    alert('Error al copiar. C√©dula: ' + text)
                }
            }

            showToast(message) {
                const toast = document.createElement('div')
                toast.style.cssText = `
                    position: fixed;
                    bottom: 30px;
                    right: 30px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                    font-weight: 600;
                `
                toast.textContent = message
                document.body.appendChild(toast)

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-out'
                    setTimeout(() => {
                        document.body.removeChild(toast)
                    }, 300)
                }, 3000)
            }

            shake() {
                const container = document.querySelector('.pin-boxes')
                container.style.animation = 'shake 0.5s'
                setTimeout(() => {
                    container.style.animation = ''
                }, 500)
            }

            selectMedicine(name, amount, unit) {
                document.getElementById('medicine-name').value = name
                document.getElementById('dosage-amount').value = amount
                document.getElementById('dosage-unit').value = unit
            }

            async submitPrescription(event) {
                event.preventDefault()

                if (!this.authenticated) {
                    alert('No autorizado')
                    return
                }

                this.showScreen('loading')

                const formData = {
                    patientCedula: document.getElementById('patient-cedula').value,
                    medicineName: document.getElementById('medicine-name').value,
                    dosage: {
                        amount: parseFloat(document.getElementById('dosage-amount').value),
                        unit: document.getElementById('dosage-unit').value
                    },
                    frequency: {
                        times: parseInt(document.getElementById('frequency-times').value),
                        period: document.getElementById('frequency-period').value
                    },
                    maxDailyDoses: parseInt(document.getElementById('max-daily').value),
                    durationDays: parseInt(document.getElementById('duration').value),
                    doctorName: document.getElementById('doctor-name').value,
                    doctorLicense: document.getElementById('doctor-license').value,
                    doctorSpecialty: document.getElementById('doctor-specialty').value || '',
                    notes: document.getElementById('notes').value || ''
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/prescriptions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    })

                    const data = await response.json()

                    if (response.ok && data.success) {
                        this.showSuccess(data.prescription)
                    } else {
                        this.showError(data.message || 'Error creando prescripci√≥n')
                    }

                } catch (error) {
                    console.error('Error:', error)
                    this.showError('Error de conexi√≥n. Verifica que el servidor est√© activo.')
                }
            }

            showSuccess(prescription) {
                this.showScreen('success')
                
                document.getElementById('prescription-details').innerHTML = `
                    <div class="patient-info">
                        <p><strong>Paciente:</strong> ${prescription.patient}</p>
                        <p><strong>C√©dula:</strong> ${prescription.patientCedula}</p>
                        <p><strong>Medicamento:</strong> ${prescription.medicine}</p>
                        <p><strong>Dosis:</strong> ${prescription.dosage}</p>
                        <p><strong>Frecuencia:</strong> ${prescription.frequency}</p>
                        <p><strong>L√≠mite diario:</strong> ${prescription.maxDailyDoses} dosis</p>
                        <p><strong>V√°lida hasta:</strong> ${new Date(prescription.endDate).toLocaleDateString()}</p>
                    </div>
                `
            }

            showError(message) {
                this.showScreen('error')
                document.getElementById('error-message').textContent = message
            }

            backToForm() {
                this.showScreen('admin')
            }

            createAnother() {
                document.getElementById('prescription-form').reset()
                this.showScreen('admin')
            }

            logout() {
                this.authenticated = false
                document.getElementById('prescription-form').reset()
                const boxes = document.querySelectorAll('.pin-box')
                boxes.forEach(b => {
                    b.value = ''
                    b.classList.remove('filled')
                })
                this.showScreen('pin')
                boxes[0].focus()
            }

            showScreen(screenName) {
                const screens = ['pin', 'admin', 'loading', 'success', 'error']
                screens.forEach(name => {
                    document.getElementById(`screen-${name}`).classList.add('hidden')
                })
                document.getElementById(`screen-${screenName}`).classList.remove('hidden')
            }
        }

        // Animation for shake
        const style = document.createElement('style')
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
                20%, 40%, 60%, 80% { transform: translateX(10px); }
            }
            @keyframes slideIn {
                from { transform: translateY(100px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(100px); opacity: 0; }
            }
        `
        document.head.appendChild(style)

        // Initialize
        const admin = new AdminPanel()
    </script>
</body>
</html>

